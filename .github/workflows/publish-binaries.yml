---
name: Build and Publish Binaries
on:
  push:
    tags:
      - v*
  workflow_dispatch: null
permissions:
  contents: write
jobs:
  build-binaries:
    name: Build Binaries
    uses: ./.github/workflows/build-compiler-binaries.yml
    with:
      artifact-prefix: binary
      retention-days: 7
  upload-to-release:
    name: Upload Binaries to Release
    runs-on: ubuntu-latest
    needs:
      - build-binaries
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: ./binaries
      - name: Rename binaries for release
        run: |
          mkdir -p artifacts
          # Rename to match expected release names
          cp binaries/binary-linux-x64/kb-dashboard-linux-x64 artifacts/kb-dashboard-linux-x64
          cp binaries/binary-darwin-x64/kb-dashboard-darwin-x64 artifacts/kb-dashboard-darwin-x64
          cp binaries/binary-darwin-arm64/kb-dashboard-darwin-arm64 artifacts/kb-dashboard-darwin-arm64
          cp binaries/binary-win32-x64/kb-dashboard-windows-x64.exe artifacts/kb-dashboard-windows-x64.exe
      - name: Upload binaries to release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: artifacts/*
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          skipIfReleaseExists: false
