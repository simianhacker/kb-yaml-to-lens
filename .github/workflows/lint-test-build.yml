---
name: Checks
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run Python linting checks
        shell: bash
        run: make compiler lint-check
  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Install markdownlint-cli
        shell: bash
        run: make docs install
      - name: Run markdownlint
        shell: bash
        run: make lint-markdown-check
  lint-yaml:
    name: Lint YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run yamlfix
        shell: bash
        run: make lint-yaml-check
  typecheck-python:
    name: Type-check Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run basedpyright
        shell: bash
        run: make compiler typecheck
  test-python:
    name: Test Python (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run pytest
        shell: bash
        run: make compiler test
  test-python-coverage:
    name: Test Python Code Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run tests with coverage
        shell: bash
        run: make compiler test-coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            packages/kb-dashboard-compiler/.coverage
            packages/kb-dashboard-compiler/htmlcov/
            packages/kb-dashboard-compiler/coverage.json
          retention-days: 30
      - name: Comment coverage on PR
        id: coverage_comment
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE_PATH: packages/kb-dashboard-compiler
      - name: Print coverage comment outputs
        shell: bash
        run: |
          echo "Coverage Vars: ${{ tojson(steps.coverage_comment.outputs) }}"
      - name: Enforce minimum Overall coverage does not decrease
        if: ${{ steps.coverage_comment.outputs.new_percent_covered < steps.coverage_comment.outputs.reference_percent_covered }}
        shell: bash
        run: |
          echo "Overall coverage decreased from ${{ steps.coverage_comment.outputs.reference_percent_covered }}% to ${{ steps.coverage_comment.outputs.new_percent_covered }}%."
          && exit 1
      - name: Enforce minimum PR coverage of 90%
        if: ${{ steps.coverage_comment.outputs.diff_total_percent_covered < 0.90 }}
        shell: bash
        run: echo "PR coverage ${{ steps.coverage_comment.outputs.diff_total_percent_covered }}% below minimum 90%" && exit 1
  test-python-cli:
    name: Test Python CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run smoke tests
        shell: bash
        run: make compiler test-smoke
  test-markdown-links:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Check documentation links
        shell: bash
        run: make docs test-links
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Install documentation dependencies
        shell: bash
        run: make docs install
      - name: Build documentation
        shell: bash
        run: make docs build
  test-vscode-extension-typescript:
    name: Test VSCode Extension (TypeScript)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Install dependencies
        shell: bash
        run: make vscode install
      - name: Run TypeScript tests for extension
        shell: bash
        run: make vscode test-unit
  test-vscode-extension-e2e:
    name: Test VSCode Extension E2E
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          setup-xvfb: 'true'
      - name: Install extension dependencies
        shell: bash
        run: make vscode install
      - name: Run E2E tests for extension
        shell: bash
        run: make vscode test
        env:
          DISPLAY: :99.0
  checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint-python
      - lint-markdown
      - lint-yaml
      - typecheck-python
      - test-python
      - test-python-coverage
      - test-python-cli
      - test-markdown-links
      - build-docs
      - test-vscode-extension-typescript
      - test-vscode-extension-e2e
    steps:
      - name: All Checks Passed
        shell: bash
        run: |-
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "Some checks failed or were cancelled"
            exit 1
          fi
          echo "All checks passed"
