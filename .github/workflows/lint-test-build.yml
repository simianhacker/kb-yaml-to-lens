---
name: Checks
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  lint-all-packages:
    name: Lint All Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Install markdownlint-cli
        shell: bash
        run: npm install -g markdownlint-cli
      - name: Run linting checks on all packages
        shell: bash
        run: make all lint-check
  typecheck-all-packages:
    name: Type-check All Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run type checking on all packages
        shell: bash
        run: make all typecheck
  test-all-packages:
    name: Test All Packages (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run unit tests on all packages
        shell: bash
        run: make all test-unit
  test-python-coverage:
    name: Test Python Code Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run tests with coverage
        shell: bash
        run: make cli test-coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            packages/kb-dashboard-cli/.coverage
            packages/kb-dashboard-cli/htmlcov/
            packages/kb-dashboard-cli/coverage.json
          retention-days: 30
      - name: Comment coverage on PR
        id: coverage_comment
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE_PATH: packages/kb-dashboard-cli
      - name: Print coverage comment outputs
        shell: bash
        run: |
          echo "Coverage Vars: ${{ tojson(steps.coverage_comment.outputs) }}"
      - name: Enforce minimum Overall coverage does not decrease
        if: ${{ steps.coverage_comment.outputs.new_percent_covered < steps.coverage_comment.outputs.reference_percent_covered }}
        shell: bash
        run: |
          echo "Overall coverage decreased from ${{ steps.coverage_comment.outputs.reference_percent_covered }}% to ${{ steps.coverage_comment.outputs.new_percent_covered }}%."
          exit 1
      - name: Enforce minimum PR coverage of 90%
        if: ${{ steps.coverage_comment.outputs.diff_total_percent_covered < 0.90 }}
        shell: bash
        run: echo "PR coverage ${{ steps.coverage_comment.outputs.diff_total_percent_covered }}% below minimum 90%" && exit 1
  docs-check-and-build:
    name: Check Documentation Links and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Install documentation dependencies
        shell: bash
        run: make docs install
      - name: Check documentation links
        shell: bash
        run: make docs test-links
      - name: Build documentation
        shell: bash
        run: make docs build
  test-all-e2e:
    name: Test E2E
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          setup-xvfb: 'true'
      - name: Run E2E tests
        shell: bash
        run: make all test-e2e
        env:
          DISPLAY: :99.0
  checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint-all-packages
      - typecheck-all-packages
      - test-all-packages
      - test-python-coverage
      - docs-check-and-build
      - test-all-e2e
    steps:
      - name: All Checks Passed
        shell: bash
        run: |-
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "Some checks failed or were cancelled"
            exit 1
          fi
          echo "All checks passed"
