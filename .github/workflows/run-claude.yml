---
# Reusable workflow for running Claude Code Action
#
# Required Secrets:
#   CONTEXT7_API_KEY - API key for Context7 MCP server (provides library documentation)
#                      Configure in: Settings → Secrets → Actions → Repository secrets
#
name: Run Claude Code Action
on:
  workflow_call:
    inputs:
      checkout-ref:
        description: Git ref to checkout
        required: false
        type: string
        default: ''
      allowed-bots:
        description: Comma-separated list of allowed bot usernames, or '*' to allow all bots
        required: false
        type: string
        default: ''
      prompt:
        description: Prompt to pass to Claude
        required: true
        type: string
      model:
        description: Model to use for Claude
        required: false
        type: string
        default: claude-opus-4-5
      allowed-tools:
        description: Comma-separated list of allowed tools for Claude
        required: true
        type: string
      claude-args:
        description: Additional arguments to pass to Claude
        required: false
        type: string
        default: ''
      track-progress:
        description: Whether Claude should track progress
        required: false
        type: boolean
        default: true
    secrets:
      claude-oauth-token:
        description: Claude OAuth token
        required: true
      context7-api-key:
        description: API key for Context7 MCP server
        required: false
jobs:
  claude:
    runs-on: ubuntu-latest
    # Note: Permissions are inherited from the calling workflow
    # Each workflow that calls this should define its own permissions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref }}
          fetch-depth: 0
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          setup-xvfb: 'true'
      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node-env
      - name: Setup MCP Server
        env:
          CONTEXT7_API_KEY: ${{ secrets.context7-api-key }}
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << EOF
          {
            "mcpServers": {
              "repository-summary": {
                "type": "http",
                "url": "https://agents-md-generator.fastmcp.app/mcp"
              },
              "code-search": {
                "type": "http",
                "url": "https://public-code-search.fastmcp.app/mcp"
              },
              "context7": {
                "type": "http",
                "url": "https://mcp.context7.com/mcp",
                "headers": {
                  "CONTEXT7_API_KEY": "$CONTEXT7_API_KEY"
                }
              }
            }
          }
          EOF
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1.0.23
        env:
          DISPLAY: :99.0
        with:
          claude_code_oauth_token: ${{ secrets.claude-oauth-token }}
          prompt: |-
            ${{ inputs.prompt }}

            # SUPERVISOR AGENT PATTERN
            You are operating as a **Supervisor Agent** that orchestrates specialized sub-agents to handle complex tasks efficiently.

            ## When to Use Sub-Agents
            **Use sub-agents for:**
            - **Complex exploration** - Use Explore agent (quick/medium/thorough) to understand unfamiliar parts of the codebase
            - **Multi-file implementations** - Use general-purpose agent for complex changes spanning multiple files
            - **Implementation planning** - Use Plan agent to design architecture and create implementation plans
            - **Context isolation** - Use sub-agents to prevent main conversation from being polluted with exploratory context
            **Handle directly as supervisor:**
            - Simple single-file changes or bug fixes
            - Running `make` commands and basic operations
            - Coordinating between sub-agents and synthesizing results
            - All communication with the user via GitHub
            - Final verification and quality checks

            ## Recommended Workflow

            ### Stage 1: Planning & Analysis
            1. For complex or unfamiliar tasks, **delegate to Explore agent** to understand the codebase
                - Use `subagent_type="Explore"` with thoroughness level: "quick", "medium", or "very thorough"
                - Explore agent has access to all tools (Glob, Grep, Read, etc.) for fast analysis
            2. For tasks requiring implementation plans, **delegate to Plan agent**
                - Use `subagent_type="Plan"` to create detailed architectural plans
                - Plan agent will explore and return a comprehensive implementation strategy

            ### Stage 2: Implementation
            1. **For complex implementations** - Delegate to general-purpose agent
                - Use `subagent_type="general-purpose"` for multi-file changes
                - Provide full context from Stage 1 analysis
                - General-purpose agent has access to all tools
            2. **For simple changes** - Handle directly as supervisor
                - Use your own tools (Edit, Write, Bash) for straightforward modifications

            ### Stage 3: Acceptance & Verification
            1. Delegate to a General Purpose Agent who will review the specific instructions from the user,
              the plan, the Agents.md, code_style, pr requirements, etc and determine if the changes are complete
              and meet the requirements.

            ### Stage 4: Final Verification
            1. **As supervisor**, run final verification:
                - Run `make all ci` to verify changes will pass CI checks
                - Review completeness against original request
                - Ensure all sub-tasks are addressed
            2. If verification fails, either fix directly or delegate fixes to general-purpose agent

            ## Sub-Agent Best Practices
            - **Think before delegating** - Don't over-delegate trivial tasks
            - **Provide full context** - Give sub-agents all necessary information in the task prompt
            - **Synthesize results** - Integrate sub-agent findings into your workflow
            - **Maintain control** - You coordinate the overall workflow; sub-agents are tools
            - **Use for isolation** - Sub-agents prevent exploratory work from cluttering main context

            ## Your Role as Supervisor
            You are ultimately responsible for making sure the specific request has been completed and that any issues encountered
             during the workflow have been addressed or are communicated to the user.
          track_progress: ${{ inputs.track-progress }}
          allowed_bots: ${{ inputs.allowed-bots }}
          claude_args: |-
            --allowed-tools ${{ inputs.allowed-tools }}
            --mcp-config /tmp/mcp-config/mcp-servers.json
            --model ${{ inputs.model }}
            ${{ inputs.claude-args }}
