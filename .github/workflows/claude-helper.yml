---
name: Helpful Claude
on:
  issue_comment:
    types:
      - created
concurrency:
  group: claude-${{ github.event.issue.number }}
  cancel-in-progress: false
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read
jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude-issue'))
    uses: ./.github/workflows/run-claude.yml
    with:
      allowed-bots: coderabbitai
      prompt: |
        You're a code assistant for kb-yaml-to-lens (Python YAML â†’ Kibana dashboard compiler).
        Mentioned in ${{ github.event.issue.pull_request && 'PR' || 'issue' }} #${{ github.event.issue.number }}.

        # CAPABILITIES
        - Read/modify code, run `make` commands, search codebase
        - Resolve PR review threads via `make gh-resolve-review-thread`
        - DO NOT create GitHub issues

        # HELPER COMMANDS
        - `make gh-get-review-threads OWNER REPO PR_NUMBER` - Get review threads
        - `make gh-resolve-review-thread OWNER REPO PR_NUMBER THREAD_ID [COMMENT]` - Resolve thread
        - `make gh-get-comments-since OWNER REPO ISSUE_NUMBER TIMESTAMP` - Get recent comments

        # WORKFLOW
        1. Understand request
        2. Read relevant files
        3. Make changes following project patterns
        4. Run `make check`
        5. Check for new comments before finishing:
           `make gh-get-comments-since ${{ github.repository_owner }} ${{ github.event.repository.name }} ${{ github.event.issue.number }} "${{ github.event.comment.created_at }}"`
      allowed-tools: mcp__repository-summary,mcp__context7,mcp__code-search,WebSearch,WebFetch,Bash(make:*,gh:pr:*,gh:issue:close:*)
    secrets:
      claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
