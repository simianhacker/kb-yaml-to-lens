---
name: PM Claude
on:
  schedule:
    - cron: 0 9 * * *
  workflow_dispatch: null
permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write
  actions: read
jobs:
  check-activity:
    runs-on: ubuntu-latest
    outputs:
      has_activity: ${{ steps.check.outputs.has_activity }}
      last_pm_issue: ${{ steps.check.outputs.last_pm_issue }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for recent activity
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          LAST_PM_ISSUE=$(gh issue list --label "project-manager" --state open --limit 1 --json number --jq '.[0].number // ""')
          echo "last_pm_issue=$LAST_PM_ISSUE" >> $GITHUB_OUTPUT
          if [ -n "$LAST_PM_ISSUE" ]; then
            ISSUE_CREATED=$(gh issue view "$LAST_PM_ISSUE" --json createdAt --jq '.createdAt')
            COMMIT_COUNT=$(git log --since="$ISSUE_CREATED" --oneline | wc -l)
            NEW_ISSUES=$(gh issue list --search "created:>=$ISSUE_CREATED -label:project-manager" --json number --jq 'length')
            NEW_PRS=$(gh pr list --search "created:>=$ISSUE_CREATED" --json number --jq 'length')
            MERGED_PRS=$(gh pr list --search "merged:>=$ISSUE_CREATED" --state merged --json number --jq 'length')
            TOTAL_ACTIVITY=$((COMMIT_COUNT + NEW_ISSUES + NEW_PRS + MERGED_PRS))
            if [ $TOTAL_ACTIVITY -lt 3 ]; then
              echo "has_activity=false" >> $GITHUB_OUTPUT
            else
              echo "has_activity=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_activity=true" >> $GITHUB_OUTPUT
          fi
  close-previous-pm-issue:
    needs: check-activity
    if: needs.check-activity.outputs.has_activity == 'true' && needs.check-activity.outputs.last_pm_issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Close previous PM issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          LAST_ISSUE="${{ needs.check-activity.outputs.last_pm_issue }}"
          gh issue comment "$LAST_ISSUE" --repo "$OWNER/$REPO" --body "Closing. New report generated."
          gh issue close "$LAST_ISSUE" --repo "$OWNER/$REPO"
  project-manager-review:
    needs:
      - check-activity
      - close-previous-pm-issue
    if: |
      always() &&
      needs.check-activity.outputs.has_activity == 'true' &&
      (needs.close-previous-pm-issue.result == 'success' || needs.close-previous-pm-issue.result == 'skipped')
    uses: ./.github/workflows/run-claude.yml
    with:
      model: claude-sonnet-4-5
      prompt: |
        You're a Project Manager for kb-yaml-to-lens (Python YAML â†’ Kibana dashboard compiler).

        # ROLE
        Review project state. DO NOT make code changes or PRs.

        # TASK
        Analyze open issues, PRs, and recent activity. Create a report with:

        ## ðŸŽ¯ Easy Pickings
        PRs ready to merge, issues to close, quick wins

        ## ðŸš¨ Urgent Items
        Blockers needing immediate attention

        ## ðŸ“‹ Decisions Needed
        Items requiring maintainer input

        ## ðŸ”„ Stale Items
        Inactive issues/PRs needing status update

        ## âœ… Recent Progress
        Merged PRs, closed issues

        ## ðŸ”§ Alignment Recommendations
        Patterns where Claude/CodeRabbit misunderstood conventions. Suggest doc updates if 2+ similar issues found.

        ## ðŸ’¡ Next Steps
        Prioritized recommendations

        # OUTPUT
        Create issue via: `gh issue create --repo "${{ github.repository_owner }}/${{ github.event.repository.name }}" --title "ðŸ“Š PM Report - $(date +%Y-%m-%d)" --body "REPORT" --label "project-manager"`
      allowed-tools: Bash(git:*,gh:issue:*,gh:pr:*)
      track-progress: false
    secrets:
      claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
