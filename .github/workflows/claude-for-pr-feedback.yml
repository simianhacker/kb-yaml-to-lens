---
name: Claude for PR Feedback
on:
  pull_request_review:
    types:
      - submitted
concurrency:
  group: claude-${{ github.event.pull_request.number }}
  cancel-in-progress: false
permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write
jobs:
  claude-pr-feedback:
    if: |
      (github.event.review.state == 'commented' || github.event.review.state == 'changes_requested') &&
      !github.event.pull_request.draft && !github.event.pull_request.closed_at &&
      !contains(github.event.pull_request.labels.*.name, 'no-claude')
    uses: ./.github/workflows/run-claude.yml
    with:
      checkout-ref: ${{ github.event.pull_request.head.ref }}
      allowed-bots: coderabbitai
      prompt: |
        You're a code assistant for kb-yaml-to-lens responding to PR review feedback.

        # YOUR TASK
        The reviewer has left review feedback on PR  #${{ github.event.pull_request.number }}.
        Your workflow:
        1. Get all open review threads from the reviewer
        2. For each thread, either:
           - Fix the code and resolve the thread, OR
           - Reply with a comment explaining why you didn't fix it and resolve the thread
        3. Repeat until there are no more open review threads

        # STEP 1: Get Open Review Threads
        Fetch all unresolved review threads:
        ```bash
        make gh-get-review-threads "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}"
        ```
        This returns JSON with unresolved review threads. Parse to get:
        - Thread ID (for resolving)
        - File path and line number
        - Comment text with the feedback

        # STEP 2: Address Each Review Thread
        For each unresolved thread:
        **Option A: Fix the code**
        1. Read the file to understand the context
        2. Make the appropriate code change
        3. Resolve the thread: `make gh-resolve-review-thread "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}" "THREAD_ID"`
        **Option B: Explain why you won't fix it**
        1. Resolve the thread with a comment explaining your reasoning:
           ```bash
           make gh-resolve-review-thread "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}" "THREAD_ID" "[your explanation]"
           ```
        The script will automatically:
        - Post your comment as a reply to the thread
        - Resolve the thread
        - Check if all threads from that review are resolved
        - Minimize the review if all threads are resolved
        Use Option B when:
        - The suggestion is incorrect or would make things worse
        - The change conflicts with project patterns/conventions
        - The issue is already addressed differently
        - The suggestion is out of scope for this PR

        # STEP 3: Verify and Test
        After addressing all threads:
        1. Run `make check` to verify linting and tests pass
        2. Fix any failures introduced by your changes
        3. Commit and push all changes

        # STEP 4: Loop Until Done
        After addressing all threads, check again for open threads:
        ```bash
        make gh-get-review-threads "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}"
        ```
        If there are still open threads, repeat from Step 2.
        If there are no open threads, you're done!

        # IMPORTANT GUIDELINES
        - Be surgical - only change what's needed to address feedback
        - Use judgment - don't blindly accept every suggestion
        - Always run tests after changes
        - Resolve ALL threads (either by fixing or explaining)
        - Don't mention the reviewer unless explaining why you won't fix something
        - Focus on fixing real issues, not perfecting code
      allowed-tools: mcp__repository-summary,mcp__context7,mcp__code-search,Bash(make:*,git:add:*,git:commit:*,git:push:*,git:status:*,git:diff:*)
    secrets:
      claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
