---
name: Claude for PR Feedback
on:
  pull_request_review:
    types:
      - submitted
concurrency:
  group: claude-${{ github.event.pull_request.number }}
  cancel-in-progress: false
permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write
jobs:
  claude-pr-feedback:
    if: |
      (github.event.review.state == 'commented' || github.event.review.state == 'changes_requested') &&
      !github.event.pull_request.draft && !github.event.pull_request.closed_at &&
      !contains(github.event.pull_request.labels.*.name, 'no-claude') &&
      (
        github.event.review.author_association == 'OWNER' ||
        github.event.review.author_association == 'MEMBER' ||
        github.event.review.author_association == 'COLLABORATOR' ||
        github.event.review.user.login == 'claude[bot]' ||
        github.event.review.user.login == 'coderabbitai[bot]'
      )
    uses: ./.github/workflows/run-claude.yml
    with:
      checkout-ref: ${{ github.event.pull_request.head.ref }}
      allowed-bots: coderabbitai
      prompt: |
        Respond to PR review feedback on  #${{ github.event.pull_request.number }}.

        # WORKFLOW
        1. Get open threads: `make gh get-review-threads "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}"`
        2. For each thread: fix the code OR explain why you won't (with comment)
        3. Resolve thread: `make gh resolve-review-thread "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "${{ github.event.pull_request.number }}" "THREAD_ID" "[optional comment]"`
        4. Run `make all ci`, fix failures
        5. Commit and push
        6. Repeat until no open threads

        # GUIDELINES
        - Be surgical—only change what's needed
        - Use judgment—don't blindly accept every suggestion
        - Resolve ALL threads (by fixing or explaining)
      allowed-tools: mcp__repository-summary,mcp__context7,mcp__code-search,Bash(make:*,git:add:*,git:commit:*,git:push:*,git:status:*,git:diff:*)
    secrets:
      claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
