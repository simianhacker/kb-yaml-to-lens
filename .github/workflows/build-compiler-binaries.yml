---
name: Build Compiler Binaries (Reusable)
on:
  workflow_call:
    inputs:
      artifact-prefix:
        description: Prefix for artifact names
        required: false
        type: string
        default: kb-dashboard
      retention-days:
        description: Number of days to retain artifacts
        required: false
        type: number
        default: 7
jobs:
  build-binaries:
    name: Build Binary - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            binary-name: kb-dashboard-linux-x64
          # macOS Intel build disabled (smoke tests failing)
          # - os: macos-15-intel
          #   platform: darwin-x64
          #   binary-name: kb-dashboard-darwin-x64
          - os: macos-14
            platform: darwin-arm64
            binary-name: kb-dashboard-darwin-arm64
          # Windows build disabled
          # - os: windows-latest
          #   platform: win32-x64
          #   binary-name: kb-dashboard-windows-x64.exe
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install UV
        uses: astral-sh/setup-uv@v7
      - name: Install dependencies
        working-directory: compiler
        run: uv sync --group build
      - name: Build binary
        working-directory: compiler
        run: make build-binary
      - name: Run smoke tests
        working-directory: compiler
        run: make test-binary-smoke
      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-prefix }}-${{ matrix.platform }}
          path: compiler/dist/${{ matrix.binary-name }}
          retention-days: ${{ inputs.retention-days }}
