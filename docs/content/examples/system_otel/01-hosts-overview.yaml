---
# Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
# or more contributor license agreements. Licensed under the Elastic License 2.0;
# you may not use this file except in compliance with the Elastic License 2.0.
# See ../../licenses/ELASTIC-LICENSE-2.0.txt for the full license text.
#
# This file is derived from the Elastic integrations repository:
# https://github.com/elastic/integrations/tree/main/packages/system_otel
#
# Modified by kb-yaml-to-lens contributors to convert from Kibana JSON format
# to YAML format for use as documentation examples.
dashboards:
  - id: otel-hosts-overview
    name: '[OTel System] Hosts Overview'
    description: Overview of all OpenTelemetry-monitored hosts with key performance metrics
    filters:
      - exists: resource.attributes.host.name
      - field: data_stream.dataset
        equals: hostmetricsreceiver.otel
    panels:
      # ═══════════════════════════════════════════════════════════════════════
      # NAVIGATION
      # ═══════════════════════════════════════════════════════════════════════
      - title: Navigation
        size: {w: 48, h: 3}
        links:
          layout: horizontal
          items:
            - label: Hosts Overview
              dashboard: otel-hosts-overview
            - label: Host Overview
              dashboard: otel-host-details-overview
            - label: Host Metrics
              dashboard: otel-host-details-metrics
            - label: Host Metadata
              dashboard: otel-host-details-metadata
            - label: Host Logs
              dashboard: otel-host-details-logs

      # ═══════════════════════════════════════════════════════════════════════
      # FLEET HEALTH SUMMARY
      # ═══════════════════════════════════════════════════════════════════════
      - title: Fleet Health
        size: {w: 48, h: 3}
        markdown:
          content: '## Fleet Health'
      - title: Total Hosts
        hide_title: true
        size: {w: 12, h: 8}
        lens:
          type: metric
          data_view: metrics-*
          primary:
            aggregation: unique_count
            field: resource.attributes.host.name
            label: Total Hosts
      - title: Hosts by OS Type
        hide_title: true
        size: {w: 12, h: 8}
        lens:
          type: metric
          data_view: metrics-*
          breakdown:
            field: resource.attributes.os.type
            label: OS Type
            size: 5
          primary:
            aggregation: unique_count
            field: resource.attributes.host.name
            label: Hosts
      - title: CPU Utilization Fleet
        hide_title: true
        size: {w: 12, h: 8}
        lens:
          type: metric
          data_view: metrics-*
          primary:
            formula: >-
              1 - (average(metrics.system.cpu.utilization, kql='attributes.state: idle') + average(metrics.system.cpu.utilization, kql='attributes.state:
              wait'))
            label: Avg CPU
            format:
              type: percent
      - title: Memory Utilization Fleet
        hide_title: true
        size: {w: 12, h: 8}
        lens:
          type: metric
          data_view: metrics-*
          primary:
            formula: "average(metrics.system.memory.utilization, kql='attributes.state : \"used\"')"
            label: Avg Memory
            format:
              type: percent

      # ═══════════════════════════════════════════════════════════════════════
      # FLEET TRENDS
      # ═══════════════════════════════════════════════════════════════════════
      - title: Fleet Trends
        size: {w: 48, h: 3}
        markdown:
          content: '## Fleet Trends'
      - title: CPU Utilization Over Time
        size: {w: 24, h: 12}
        lens:
          type: line
          data_view: metrics-*
          dimension:
            field: '@timestamp'
            type: date_histogram
          breakdown:
            type: values
            field: resource.attributes.host.name
            size: 10
          metrics:
            - formula: >-
                1 - (average(metrics.system.cpu.utilization, kql='attributes.state: idle') + average(metrics.system.cpu.utilization, kql='attributes.state:
                wait'))
              label: CPU Utilization
              format:
                type: percent
      - title: Memory Utilization Over Time
        size: {w: 24, h: 12}
        lens:
          type: area
          data_view: metrics-*
          dimension:
            field: '@timestamp'
            type: date_histogram
          breakdown:
            type: values
            field: resource.attributes.host.name
            size: 10
          metrics:
            - formula: "average(metrics.system.memory.utilization, kql='attributes.state : \"used\"')"
              label: Memory Utilization
              format:
                type: percent

      # ═══════════════════════════════════════════════════════════════════════
      # HOST DETAILS TABLE
      # ═══════════════════════════════════════════════════════════════════════
      - title: Host Details
        size: {w: 48, h: 3}
        markdown:
          content: '## Host Details'
      - title: Host Performance Summary
        size: {w: 48, h: 20}
        lens:
          type: datatable
          data_view: metrics-*
          dimensions:
            - id: hostname
              type: values
              field: resource.attributes.host.name
              label: Host
              size: 100
            - id: os
              type: values
              field: resource.attributes.os.type
              label: OS
              size: 1
          metrics:
            - id: cpu-util
              formula: >-
                1 - (average(metrics.system.cpu.utilization, kql='attributes.state: idle') + average(metrics.system.cpu.utilization, kql='attributes.state:
                wait'))
              label: CPU %
              format:
                type: percent
            - id: mem-util
              formula: "average(metrics.system.memory.utilization, kql='attributes.state : \"used\"')"
              label: Memory %
              format:
                type: percent
            - id: norm-load
              formula: average(metrics.system.cpu.load_average.1m) / max(metrics.system.cpu.logical.count)
              label: Normalized Load
              format:
                type: percent
            - id: disk-util
              aggregation: average
              field: metrics.system.filesystem.utilization
              label: Disk %
              format:
                type: percent
          paging:
            enabled: true
            page_size: 10
