---
# Redis OpenTelemetry Overview Dashboard (ES|QL Version)
# Provides cluster-level metrics and instance health monitoring
#
# Metrics reference: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/redisreceiver
# Requires metrics-* with data_stream.dataset == "redisreceiver.otel"
dashboards:
  - id: redis-overview
    name: '[Metrics Redis] Overview'
    description: OpenTelemetry Redis Receiver - Overview dashboard showing key metrics across all Redis instances (ES|QL)
    filters:
      - field: data_stream.dataset
        equals: redisreceiver.otel
    controls:
      - type: options
        id: instance-filter
        label: Instance
        width: medium
        data_view: metrics-*
        field: resource.attributes.service.instance.id
    panels:
      # Navigation Links
      - size: {w: 48, h: 2}
        position: {x: 0, y: 0}
        links:
          layout: horizontal
          items:
            - label: Overview
              dashboard: redis-overview
            - label: Instance Details
              dashboard: redis-instance-details
            - label: Database Metrics
              dashboard: redis-database-metrics
            - label: Redis Documentation
              url: https://redis.io/docs/

      # Section Header
      - position: {x: 0, y: 2}
        size: {w: 48, h: 3}
        markdown:
          content: '## Redis Instance Overview'

      # KPI Metrics Row
      - title: Total Redis Instances
        hide_title: true
        position: {x: 0, y: 5}
        size: {w: 8, h: 5}
        esql:
          type: metric
          query: |
            FROM metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE resource.attributes.service.instance.id IS NOT NULL
            | STATS instances = COUNT_DISTINCT(resource.attributes.service.instance.id)
          primary:
            field: instances
            label: Instances
      - title: Total Client Connections
        hide_title: true
        position: {x: 8, y: 5}
        size: {w: 8, h: 5}
        esql:
          type: metric
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.clients.connected IS NOT NULL
            | STATS clients = SUM(LAST_OVER_TIME(redis.clients.connected))
              BY instance = resource.attributes.service.instance.id
            | STATS clients = SUM(clients)
          primary:
            field: clients
            label: Clients
      - title: Commands/sec
        hide_title: true
        position: {x: 16, y: 5}
        size: {w: 8, h: 5}
        description: Gauge metric showing instantaneous commands per second
        esql:
          type: metric
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.commands IS NOT NULL
            | STATS commands_per_sec = SUM(LAST_OVER_TIME(redis.commands))
              BY instance = resource.attributes.service.instance.id
            | STATS commands_per_sec = SUM(commands_per_sec)
          primary:
            field: commands_per_sec
            label: Commands/sec
      - title: Cache Hit Rate
        hide_title: true
        position: {x: 24, y: 5}
        size: {w: 8, h: 5}
        esql:
          type: metric
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.keyspace.hits IS NOT NULL OR redis.keyspace.misses IS NOT NULL
            | STATS hits = SUM(RATE(redis.keyspace.hits)), misses = SUM(RATE(redis.keyspace.misses))
            | EVAL hit_rate = hits / (hits + misses + 0.000001)
            | KEEP hit_rate
          primary:
            field: hit_rate
            label: Hit Rate
            format:
              type: percent
      - title: Total Memory Usage
        hide_title: true
        position: {x: 32, y: 5}
        size: {w: 8, h: 5}
        esql:
          type: metric
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.memory.used IS NOT NULL
            | STATS memory = SUM(LAST_OVER_TIME(redis.memory.used))
              BY instance = resource.attributes.service.instance.id
            | STATS memory = SUM(memory)
          primary:
            field: memory
            label: Memory
            format:
              type: bytes
      - title: Avg Memory Fragmentation
        hide_title: true
        position: {x: 40, y: 5}
        size: {w: 8, h: 5}
        esql:
          type: metric
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.memory.fragmentation_ratio IS NOT NULL
            | STATS fragmentation = AVG(LAST_OVER_TIME(redis.memory.fragmentation_ratio))
          primary:
            field: fragmentation
            label: Fragmentation

      # Section Header
      - position: {x: 0, y: 10}
        size: {w: 48, h: 3}
        markdown:
          content: '## Memory & Performance Trends'

      # Memory Usage by Instance (Gauge - use LAST_OVER_TIME for current state)
      - title: Memory Usage by Instance
        position: {x: 0, y: 13}
        size: {w: 24, h: 12}
        esql:
          type: area
          mode: stacked
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.memory.used IS NOT NULL
            | STATS memory = MAX(LAST_OVER_TIME(redis.memory.used))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: memory
              label: Memory Used
              format:
                type: bytes
          breakdown:
            field: instance

      # Commands Per Second (Gauge metric - use LAST_OVER_TIME for current state)
      - title: Commands Per Second
        position: {x: 24, y: 13}
        size: {w: 24, h: 12}
        esql:
          type: line
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.commands IS NOT NULL
            | STATS commands = MAX(LAST_OVER_TIME(redis.commands))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: commands
              label: Commands/sec
          breakdown:
            field: instance

      # Client Connections Over Time (Gauge - use LAST_OVER_TIME for current state)
      - title: Client Connections Over Time
        position: {x: 0, y: 25}
        size: {w: 24, h: 12}
        esql:
          type: line
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.clients.connected IS NOT NULL
            | STATS clients = MAX(LAST_OVER_TIME(redis.clients.connected))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: clients
              label: Connected Clients
          breakdown:
            field: instance

      # Keyspace Hit/Miss Rate (Counter metrics - use RATE)
      - title: Keyspace Hit/Miss Rate
        position: {x: 24, y: 25}
        size: {w: 24, h: 12}
        esql:
          type: area
          mode: stacked
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.keyspace.hits IS NOT NULL OR redis.keyspace.misses IS NOT NULL
            | STATS hits = SUM(RATE(redis.keyspace.hits)), misses = SUM(RATE(redis.keyspace.misses))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend)
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: hits
              label: Hits/sec
            - field: misses
              label: Misses/sec

      # Section Header
      - position: {x: 0, y: 37}
        size: {w: 48, h: 3}
        markdown:
          content: '## Key Eviction & Expiration'

      # Keys Evicted Rate (Counter - use RATE)
      - title: Keys Evicted Rate
        position: {x: 0, y: 40}
        size: {w: 24, h: 12}
        esql:
          type: line
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.keys.evicted IS NOT NULL
            | STATS evicted = SUM(RATE(redis.keys.evicted))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: evicted
              label: Evicted/sec
          breakdown:
            field: instance

      # Keys Expired Rate (Counter - use RATE)
      - title: Keys Expired Rate
        position: {x: 24, y: 40}
        size: {w: 24, h: 12}
        esql:
          type: line
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.keys.expired IS NOT NULL
            | STATS expired = SUM(RATE(redis.keys.expired))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: expired
              label: Expired/sec
          breakdown:
            field: instance

      # Section Header
      - position: {x: 0, y: 52}
        size: {w: 48, h: 3}
        markdown:
          content: '## Network I/O'

      # Network Input (Counter - use RATE)
      - title: Network Input (Bytes Received)
        position: {x: 0, y: 55}
        size: {w: 24, h: 12}
        esql:
          type: area
          mode: stacked
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.net.input IS NOT NULL
            | STATS input = SUM(RATE(redis.net.input))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: input
              label: Input
              format:
                type: bytes
          breakdown:
            field: instance

      # Network Output (Counter - use RATE)
      - title: Network Output (Bytes Sent)
        position: {x: 24, y: 55}
        size: {w: 24, h: 12}
        esql:
          type: area
          mode: stacked
          query: |
            TS metrics-*
            | WHERE data_stream.dataset == "redisreceiver.otel"
            | WHERE redis.net.output IS NOT NULL
            | STATS output = SUM(RATE(redis.net.output))
              BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), instance = resource.attributes.service.instance.id
            | SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: output
              label: Output
              format:
                type: bytes
          breakdown:
            field: instance

      # Section Header
      - position: {x: 0, y: 67}
        size: {w: 48, h: 3}
        markdown:
          content: '## Instance Summary Table'

      # Instance Summary DataTable
      - title: Redis Instance Metrics Summary
        position: {x: 0, y: 70}
        size: {w: 48, h: 20}
        esql:
          type: datatable
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "redisreceiver.otel"
            - WHERE resource.attributes.service.instance.id IS NOT NULL
            - STATS memory = MAX(LAST_OVER_TIME(redis.memory.used)), clients = MAX(LAST_OVER_TIME(redis.clients.connected)), commands = MAX(LAST_OVER_TIME(redis.commands)),
              fragmentation = MAX(LAST_OVER_TIME(redis.memory.fragmentation_ratio)) BY instance = resource.attributes.service.instance.id
            - KEEP instance, memory, clients, commands, fragmentation
            - SORT memory DESC
            - LIMIT 100
          dimensions:
            - field: instance
            - field: memory
            - field: clients
            - field: commands
            - field: fragmentation
