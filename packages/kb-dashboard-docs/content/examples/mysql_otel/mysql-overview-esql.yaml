---
# MySQL OpenTelemetry Overview Dashboard (ES|QL Version)
# Comprehensive MySQL metrics dashboard using OpenTelemetry MySQL receiver
# Uses ES|QL with TS command for time-series optimization
#
# Metrics reference: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/mysqlreceiver
dashboards:
  - id: mysql-otel-overview-esql
    name: '[Metrics MySQL] Overview'
    description: Comprehensive MySQL metrics dashboard using OpenTelemetry MySQL receiver (ES|QL version with TS command)
    controls:
      - type: options
        label: MySQL Host
        data_view: metrics-*
        field: resource.attributes.host.name
      - type: options
        label: MySQL Instance
        data_view: metrics-*
        field: resource.attributes.service.instance.id
    filters:
      - field: data_stream.dataset
        equals: mysqlreceiver.otel
    panels:
      # Navigation Links
      - title: Navigation Links
        size: {w: 48, h: 2}
        links:
          layout: horizontal
          items:
            - label: MySQL Overview
              dashboard: mysql-otel-overview-esql
            - label: MySQL Extended
              dashboard: mysql-otel-extended-esql

      # Overview Metrics Row (y=2, h=6)
      - title: Active Connections
        description: Connected client threads. Excludes aborted and disconnected threads.
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE attributes.kind == "connected"
            - STATS active_connections = MAX(mysql.threads)
          primary:
            field: active_connections
            label: Active Connections
      - title: Buffer Pool Efficiency
        description: >-
          Clean pages / total pages. Higher = efficient memory use. Lower =
          more dirty pages requiring flush.
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.buffer_pool.usage IS NOT NULL
            - STATS clean_pages = MAX(mysql.buffer_pool.usage) BY attributes.status
            - STATS total = SUM(clean_pages), clean = SUM(CASE(attributes.status == "clean", clean_pages, 0))
            - EVAL efficiency = clean / total
          primary:
            field: efficiency
            label: Buffer Pool Efficiency
            format:
              type: percent
      - title: InnoDB Operations Rate
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.operations IS NOT NULL
            - STATS ops_rate = SUM(RATE(mysql.operations))
          primary:
            field: ops_rate
            label: InnoDB Ops/sec
      - title: Handler Operations Rate
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.handlers IS NOT NULL
            - STATS handler_rate = SUM(RATE(mysql.handlers))
          primary:
            field: handler_rate
            label: Handler Ops/sec

      # Buffer Pool Performance Section (y=8)
      - title: Buffer Pool Usage Over Time
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.buffer_pool.usage IS NOT NULL
            - STATS usage = MAX(mysql.buffer_pool.usage) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), status = attributes.status
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: usage
              label: Buffer Pool Usage
              format:
                type: bytes
          breakdown:
            field: status
      - title: Buffer Pool Pages
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.buffer_pool.pages IS NOT NULL
            - STATS pages = MAX(mysql.buffer_pool.pages) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: pages
              label: Buffer Pool Pages
          breakdown:
            field: kind
      - title: Buffer Pool Operations
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.buffer_pool.operations IS NOT NULL
            - STATS ops_rate = SUM(RATE(mysql.buffer_pool.operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation =
              attributes.operation
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: ops_rate
              label: Operations/sec
          breakdown:
            field: operation
      - title: Buffer Pool Page Flushes
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.buffer_pool.page_flushes IS NOT NULL
            - STATS flush_rate = SUM(RATE(mysql.buffer_pool.page_flushes)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend)
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: flush_rate
              label: Page Flushes/sec

      # InnoDB Operations Section (y=26)
      - title: Row Operations
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.row_operations IS NOT NULL
            - STATS row_ops_rate = SUM(RATE(mysql.row_operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation = attributes.operation
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: row_ops_rate
              label: Row Ops/sec
          breakdown:
            field: operation
      - title: Page Operations
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.page_operations IS NOT NULL
            - STATS page_ops_rate = SUM(RATE(mysql.page_operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation = attributes.operation
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: page_ops_rate
              label: Page Ops/sec
          breakdown:
            field: operation
      - title: InnoDB Operations (fsyncs, reads, writes)
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.operations IS NOT NULL
            - STATS ops_rate = SUM(RATE(mysql.operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation = attributes.operation
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: ops_rate
              label: Operations/sec
          breakdown:
            field: operation
      - title: Double Writes
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.double_writes IS NOT NULL
            - STATS double_writes_rate = SUM(RATE(mysql.double_writes)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: double_writes_rate
              label: Double Writes/sec
          breakdown:
            field: kind

      # Handler Operations Section (y=44)
      - title: Handler Operations
        size: {w: 48, h: 9}
        description: Handler operations rate by type
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.handlers IS NOT NULL
            - STATS handler_rate = SUM(RATE(mysql.handlers)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: handler_rate
              label: Handler Ops/sec
          breakdown:
            field: kind

      # Locks & Waits Section (y=53)
      - title: Lock Waits
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.locks IS NOT NULL
            - STATS lock_rate = SUM(RATE(mysql.locks)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: lock_rate
              label: Locks/sec
          breakdown:
            field: kind
      - title: Row Lock Waits
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.row_locks IS NOT NULL
            - STATS row_lock_rate = SUM(RATE(mysql.row_locks)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: row_lock_rate
              label: Row Locks/sec
          breakdown:
            field: kind

      # Log Operations Section (y=62)
      - title: Log Operations
        size: {w: 48, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.log_operations IS NOT NULL
            - STATS log_ops_rate = SUM(RATE(mysql.log_operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation = attributes.operation
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: log_ops_rate
              label: Log Ops/sec
          breakdown:
            field: operation

      # Table I/O Waits Section (y=71)
      - title: Table I/O Waits/sec by Table
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.table.io.wait.count IS NOT NULL
            - STATS table_io_wait_rate = SUM(RATE(mysql.table.io.wait.count)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), table
              = attributes.table
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: table_io_wait_rate
              label: Table I/O Waits/sec
          breakdown:
            field: table
      - title: Index I/O Waits/sec by Index
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.index.io.wait.count IS NOT NULL
            - STATS index_io_wait_rate = SUM(RATE(mysql.index.io.wait.count)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), index
              = attributes.index
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: index_io_wait_rate
              label: Index I/O Waits/sec
          breakdown:
            field: index

      # Resources Section (y=80)
      - title: Opened Resources
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.opened_resources IS NOT NULL
            - STATS opened_rate = SUM(RATE(mysql.opened_resources)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: opened_rate
              label: Opened Resources/sec
          breakdown:
            field: kind
      - title: Temporary Resources
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.tmp_resources IS NOT NULL
            - STATS tmp_rate = SUM(RATE(mysql.tmp_resources)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), resource = attributes.resource
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: tmp_rate
              label: Temp Resources/sec
          breakdown:
            field: resource

      # Threads & Sorts Section (y=89)
      - title: Thread Metrics
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.threads IS NOT NULL
            - STATS thread_count = MAX(mysql.threads) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: thread_count
              label: Threads
          breakdown:
            field: kind
      - title: Sort Operations
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.sorts IS NOT NULL
            - STATS sorts_rate = SUM(RATE(mysql.sorts)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), kind = attributes.kind
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: sorts_rate
              label: Sorts/sec
          breakdown:
            field: kind

      # Uptime & Connection Stats (y=98)
      - title: MySQL Uptime
        size: {w: 24, h: 9}
        description: MySQL server uptime rate (should be 1 second/second when running)
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.uptime IS NOT NULL
            - STATS uptime_rate = SUM(RATE(mysql.uptime)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend)
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: uptime_rate
              label: Uptime Rate (sec/sec)
      - title: MySQLx Connections
        size: {w: 24, h: 9}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "mysqlreceiver.otel"
            - WHERE mysql.mysqlx_connections IS NOT NULL
            - STATS mysqlx_conn_rate = SUM(RATE(mysql.mysqlx_connections)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), status =
              attributes.status
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
          metrics:
            - field: mysqlx_conn_rate
              label: MySQLx Connections/sec
          breakdown:
            field: status
