---
# PostgreSQL OpenTelemetry Overview Dashboard (ES|QL Version)
# Comprehensive PostgreSQL metrics dashboard using OpenTelemetry PostgreSQL receiver
# Uses ES|QL with TS command for time-series optimization
#
# Requirements:
#   - data_stream.dataset == "postgresqlreceiver.otel"
#   - Enable postgresql.connection.max metric for the Max Connections KPI panel
#   - Enable postgresql.database.count metric for the Database Count KPI panel
#
# Metrics reference: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/postgresqlreceiver
dashboards:
  - id: postgresql-otel-overview-esql
    name: '[Metrics PostgreSQL] Overview'
    description: Comprehensive PostgreSQL metrics dashboard using OpenTelemetry PostgreSQL receiver
    controls:
      - type: options
        label: Database Name
        data_view: metrics-*
        field: resource.attributes.postgresql.database.name
      - type: options
        label: Instance
        data_view: metrics-*
        field: resource.attributes.service.instance.id
    filters:
      - field: data_stream.dataset
        equals: postgresqlreceiver.otel
      - exists: resource.attributes.postgresql.database.name
    panels:
      # KPI Metrics Row (y=0, h=6)
      - title: Total Databases
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - FROM metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE resource.attributes.postgresql.database.name IS NOT NULL
            - STATS total_databases = COUNT_DISTINCT(resource.attributes.postgresql.database.name)
          primary:
            field: total_databases
            label: Databases
      - title: Active Connections
        hide_title: true
        size: {w: 12, h: 4}
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.backends IS NOT NULL
            - STATS active_backends = SUM(LAST_OVER_TIME(postgresql.backends))
          primary:
            field: active_backends
            label: Active Backends
      - title: Max Connections
        hide_title: true
        size: {w: 12, h: 4}
        description: Requires postgresql.connection.max metric (enable in OTel collector)
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.connection.max IS NOT NULL
            - STATS max_connections = MAX(LAST_OVER_TIME(postgresql.connection.max))
          primary:
            field: max_connections
            label: Max Connections
      - title: Database Count
        hide_title: true
        size: {w: 12, h: 4}
        description: Requires postgresql.database.count metric (enable in OTel collector)
        esql:
          type: metric
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.database.count IS NOT NULL
            - STATS db_count = MAX(LAST_OVER_TIME(TO_LONG(postgresql.database.count)))
          primary:
            field: db_count
            label: Total DB Count

      # Performance Summary DataTable (y=6)
      - title: Database Performance Summary
        size: {w: 48, h: 18}
        description: Peak metrics per database over the selected time range. Counter metrics show maximum cumulative values.
        esql:
          type: datatable
          query:
            - FROM metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE resource.attributes.postgresql.database.name IS NOT NULL
            - STATS backends_count = ROUND(MAX(postgresql.backends), 0), size_bytes = MAX(postgresql.db_size), commit_total = MAX(TO_LONG(postgresql.commits)),
              rollback_total = MAX(TO_LONG(postgresql.rollbacks)), blocks_read_total = MAX(TO_LONG(postgresql.blocks_read)) BY database = resource.attributes.postgresql.database.name
            - KEEP database, backends_count, size_bytes, commit_total, rollback_total, blocks_read_total
            - SORT database ASC
            - LIMIT 100
          dimensions:
            - field: database
            - field: backends_count
            - field: size_bytes
            - field: commit_total
            - field: rollback_total
            - field: blocks_read_total

      # Connections Over Time (y=24)
      - title: Active Connections Over Time
        size: {w: 48, h: 10}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.backends IS NOT NULL
            - STATS connections = MAX(AVG_OVER_TIME(postgresql.backends)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), database
              = resource.attributes.postgresql.database.name
            - SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: connections
              label: Active Connections
          breakdown:
            field: database

      # Transaction Rates (y=34)
      - title: Commits Rate
        size: {w: 24, h: 10}
        esql:
          type: area
          mode: stacked
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.commits IS NOT NULL
            - STATS commits_rate = SUM(RATE(postgresql.commits)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), database = resource.attributes.postgresql.database.name
            - SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: commits_rate
              label: Commits/sec
              format:
                type: number
                decimals: 2
          breakdown:
            field: database
      - title: Rollbacks Rate
        size: {w: 24, h: 10}
        esql:
          type: area
          mode: stacked
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.rollbacks IS NOT NULL
            - STATS rollbacks_rate = SUM(RATE(postgresql.rollbacks)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), database = resource.attributes.postgresql.database.name
            - SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: rollbacks_rate
              label: Rollbacks/sec
              format:
                type: number
                decimals: 2
          breakdown:
            field: database

      # Block I/O (y=44)
      - title: Block I/O by Source
        size: {w: 48, h: 12}
        esql:
          type: line
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.blocks_read IS NOT NULL
            - STATS blocks_rate = SUM(RATE(postgresql.blocks_read)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), source = attributes.source
            - SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: blocks_rate
              label: Blocks Read/sec
          breakdown:
            field: source

      # Database Operations (y=56)
      - title: Operations by Type
        size: {w: 48, h: 12}
        esql:
          type: bar
          mode: stacked
          query:
            - TS metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.operations IS NOT NULL
            - STATS operations_rate = SUM(RATE(postgresql.operations)) BY time_bucket = BUCKET(@timestamp, 20, ?_tstart, ?_tend), operation =
              attributes.operation
            - SORT time_bucket ASC
          legend:
            visible: show
            position: right
          dimension:
            field: time_bucket
          metrics:
            - field: operations_rate
              label: Operations/sec
          breakdown:
            field: operation

      # Distribution Charts (y=68)
      - title: Database Sizes
        size: {w: 24, h: 10}
        esql:
          type: pie
          query:
            - FROM metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.db_size IS NOT NULL
            - STATS db_size = MAX(postgresql.db_size) BY database = resource.attributes.postgresql.database.name
            - SORT db_size DESC
            - LIMIT 20
          metrics:
            - field: db_size
              label: Size
              format:
                type: bytes
                decimals: 2
          dimensions:
            - field: database
          appearance:
            donut: medium
      - title: Connection States
        size: {w: 24, h: 10}
        esql:
          type: pie
          query:
            - FROM metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE postgresql.backends IS NOT NULL
            - WHERE attributes.state IS NOT NULL
            - STATS connections = MAX(postgresql.backends) BY state = attributes.state
            - SORT connections DESC
            - LIMIT 10
          metrics:
            - field: connections
              label: Connections
              format:
                type: number
                decimals: 0
          dimensions:
            - field: state
          appearance:
            donut: medium

      # Metadata Table (y=78)
      - title: Database Metadata
        size: {w: 48, h: 12}
        description: List of monitored databases and their host locations
        esql:
          type: datatable
          query:
            - FROM metrics-*
            - WHERE data_stream.dataset == "postgresqlreceiver.otel"
            - WHERE resource.attributes.postgresql.database.name IS NOT NULL
            - STATS BY database = resource.attributes.postgresql.database.name, instance = resource.attributes.service.instance.id
            - KEEP database, instance
            - SORT database ASC
            - LIMIT 100
          dimensions:
            - field: database
            - field: instance
